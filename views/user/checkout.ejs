<!DOCTYPE html>
<html lang="en">

<head>
    <title>Shoeme</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Colo Shop Template">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/template/styles/bootstrap4/bootstrap.min.css">
    <link href="/template/plugins/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="/template/plugins/OwlCarousel2-2.2.1/owl.carousel.css">
    <link rel="stylesheet" type="text/css" href="/template/plugins/OwlCarousel2-2.2.1/owl.theme.default.css">
    <link rel="stylesheet" type="text/css" href="/template/plugins/OwlCarousel2-2.2.1/animate.css">
    <link rel="stylesheet" href="/template/plugins/themify-icons/themify-icons.css">
    <link rel="stylesheet" type="text/css" href="/template/plugins/jquery-ui-1.12.1.custom/jquery-ui.css">
    <link rel="stylesheet" type="text/css" href="/template/styles/single_styles.css">
    <link rel="stylesheet" type="text/css" href="/template/styles/single_responsive.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

    <!-- Bootstrap -->
    <link type="text/css" rel="stylesheet" href="/main/css/bootstrap.min.css" />

    <!-- Slick -->
    <link type="text/css" rel="stylesheet" href="/main/css/slick.css" />
    <link type="text/css" rel="stylesheet" href="/main/css/slick-theme.css" />

    <!-- nouislider -->
    <link type="text/css" rel="stylesheet" href="/main/css/nouislider.min.css" />

    <!-- Font Awesome Icon -->
    <link rel="stylesheet" href="/main/css/font-awesome.min.css">

    <!-- Custom stlylesheet -->
    <link type="text/css" rel="stylesheet" href="/main/css/style.css" />



</head>

<body>

    <div class="super_container">

        <!-- Header -->

        <%-include('userloged') %>

            <!-- SECTION -->
            <div class="section">
                <div class="container">
                    <div class="row">
                        <div class="col-md-7">

                            <div class="accordion accordion-flush " id="accordionFlushExample">
                                <div class="accordion-item ">
                                    <h2 class="accordion-header bg-muted" id="flush-headingOne">
                                        <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#flush-collapseOne"
                                            aria-expanded="false" aria-controls="flush-collapseOne">
                                            <h5>ADD ADDRESS</h5>
                                        </button>
                                    </h2>
                                    <div id="flush-collapseOne" class="accordion-collapse collapse"
                                        aria-labelledby="flush-headingOne" data-bs-parent="#accordionFlushExample">
                                        <div class="accordion-body">
                                            <div class="billing-details">

                                                <form action="/addAddress" method="post">
                                                    <div class="form-group">
                                                        <input class="input" type="text" name="fullname" id="aName"
                                                            placeholder="Full Name" oninput="validateAName()">
                                                        <span id="aNameError" style="color: red;"></span>
                                                    </div>
                                                    <div class="form-group">
                                                        <input class="input" type="email" name="email" id="aEmail"
                                                            placeholder="Email" oninput="validateAEmail()">
                                                        <span id="aEmailError" style="color: red;"></span>
                                                    </div>
                                                    <div class="form-group">
                                                        <input class="input" type="text" name="address" id="address"
                                                            placeholder="Address" oninput="validateAddress()">
                                                        <span id="addressError" style="color: red;"></span>
                                                    </div>

                                                    <div class="form-group">
                                                        <input class="input" type="text" name="city" id="city"
                                                            placeholder="City" oninput="validateCityName()">
                                                        <span id="cityNameError" style="color: red;"></span>
                                                    </div>
                                                    <div class="form-group">
                                                        <input class="input" type="text" name="country" id="countryName"
                                                            placeholder="Country" oninput="validateCountryName()">
                                                        <span id="countryNameError" style="color: red;"></span>
                                                    </div>
                                                    <div class="form-group">
                                                        <input class="input" type="text" name="pin" id="pin"
                                                            placeholder="PIN Code" oninput="validatePinCode()">
                                                        <span id="pinError" style="color: red;"></span>
                                                    </div>
                                                    <div class="form-group">
                                                        <input class="input" type="tel" name="tel" id="aNumber"
                                                            placeholder="Telephone" oninput="validateAMobile()">
                                                        <span id="aNumberError" style="color: red;"></span>
                                                    </div>
                                                    <input type="submit" Id="aSubmitButton" name="aSubmitButton"
                                                        value="Add Address" class="btn btn-block btn-dark">
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                            </div>

                            <br>


                            <div class="address-section">
                                <% userData.address.forEach((i, index)=> { %>
                                    <div class="address-card">
                                        <input type="radio" name="selectedAddress" value="<%= index %>">
                                        <p><strong>Full Name:</strong>
                                            <%= i.fullname %>
                                        </p>
                                        <p><strong>Email ID:</strong>
                                            <%= i.email %>
                                        </p>
                                        <p><strong>Address:</strong>
                                            <%= i.address %>
                                        </p>
                                        <p><strong>City:</strong>
                                            <%= i.city %>
                                        </p>
                                        <p><strong>Country:</strong>
                                            <%= i.country %>
                                        </p>
                                        <p><strong>PIN:</strong>
                                            <%= i.pin %>
                                        </p>
                                        <p><strong>Telephone:</strong>
                                            <%= i.tel %>
                                        </p>
                                    </div>
                                    <% }) %>
                            </div>

                        </div>
                        <div class="col-md-5 order-details">
                            <div class="section-title text-center">
                                <h3 class="title">Your Order</h3>
                            </div>
                            <div class="order-summary">
                                <div class="order-col">
                                    <div><strong>PRODUCT</strong></div>
                                    <div><strong>TOTAL</strong></div>
                                </div>
                                <% items.forEach((i)=> { %>
                                    <div class="order-products">
                                        <div class="order-col">
                                            <div>
                                                <%= i.item.quantity %> x <%= i.item.product.productName %>
                                            </div>
                                            <div>
                                                ₹ <%= (i.item.product.price)*(i.item.quantity) %>
                                            </div>
                                        </div>
                                    </div>
                                    <% }); %>
                                        <div class="order-col">
                                            <div>Shipping</div>
                                            <div><strong>FREE</strong></div>
                                        </div>
                                        <div class="order-col">
                                            <div><strong>TOTAL</strong></div>
                                            <div><strong class="order-total">
                                                    ₹ <%= totalPrice %>
                                                </strong></div>
                                        </div>
                            </div>
                            <div style="display: flex; justify-content: center; align-items: center;gap:10px">
                                <select class="w-50 mx-auto my-3 " name="coupon"
                                    onchange="applyCoupon(this.value)">
                                    <option value="">Select Coupon</option>
                                    <% for (let i=0; i < coupon.length; i++) { %>
                                        <option value="<%= coupon[i]._id %>">
                                            <%= coupon[i].code %>
                                        </option>
                                        <% } %>
                                </select>
                                <button class="btn btn-danger" id="couponCancelbutton" onclick="cancelSelection()"
                                    style="display: none; margin: auto;">Cancel</button>
                            </div>


                            <div class="wallet-method" style="display:flex;margin-top: 10px;">

                                <input type="checkbox" name="wallet" id="wallet-0" style="margin:0px">
                                <label for="wallet-0" style="margin-bottom:0px">
                                    &nbsp;&nbsp;Pay from wallet (Current Balance:₹<%= userData.wallet %> )
                                </label>
                            </div>
                            <div class="payment-method">
                                <div class="input-radio">
                                    <input type="radio" name="payment" id="payment-0">
                                    <label for="payment-0">
                                        <span></span>
                                        Cash On Delivery
                                    </label>
                                </div>
                                <div class="input-radio">
                                    <input type="radio" name="payment" id="payment-1">
                                    <label for="payment-1">
                                        <span></span>
                                        UPI
                                    </label>
                                </div>
                                <div class="input-radio">
                                    <input type="radio" name="payment" id="payment-2">
                                    <label for="payment-2">
                                        <span></span>
                                        Credit/Debit Card
                                    </label>
                                </div>
                            </div>
                            <a class="primary-btn text-white order-submit"
                                onclick="submitOrder(event,' <%=items[0].userId %>','<%= totalPrice %>')"
                                id="rzp-button1">Pay <%= totalPrice %></a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /SECTION -->



            <!-- Benefit -->

            <div class="benefit">
                <div class="container">
                    <div class="row benefit_row">
                        <div class="col-lg-3 benefit_col">
                            <div class="benefit_item d-flex flex-row align-items-center">
                                <div class="benefit_icon"><i class="fa fa-truck" aria-hidden="true"></i></div>
                                <div class="benefit_content">
                                    <h6>free shipping</h6>
                                    <p>Suffered Alteration in Some Form</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 benefit_col">
                            <div class="benefit_item d-flex flex-row align-items-center">
                                <div class="benefit_icon"><i class="fa fa-money" aria-hidden="true"></i></div>
                                <div class="benefit_content">
                                    <h6>cach on delivery</h6>
                                    <p>The Internet Tend To Repeat</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 benefit_col">
                            <div class="benefit_item d-flex flex-row align-items-center">
                                <div class="benefit_icon"><i class="fa fa-undo" aria-hidden="true"></i></div>
                                <div class="benefit_content">
                                    <h6>45 days return</h6>
                                    <p>Making it Look Like Readable</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 benefit_col">
                            <div class="benefit_item d-flex flex-row align-items-center">
                                <div class="benefit_icon"><i class="fa fa-clock-o" aria-hidden="true"></i></div>
                                <div class="benefit_content">
                                    <h6>opening all week</h6>
                                    <p>8AM - 09PM</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Newsletter -->



            <!-- Footer -->

            <footer class="footer">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-6">
                            <div
                                class="footer_nav_container d-flex flex-sm-row flex-column align-items-center justify-content-lg-start justify-content-center text-center">
                                <ul class="footer_nav">
                                    <li><a href="#">Blog</a></li>
                                    <li><a href="#">FAQs</a></li>
                                    <li><a href="contact.html">Contact us</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div
                                class="footer_social d-flex flex-row align-items-center justify-content-lg-end justify-content-center">
                                <ul>
                                    <li><a href="#"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
                                    <li><a href="#"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
                                    <li><a href="#"><i class="fa fa-instagram" aria-hidden="true"></i></a></li>
                                    <li><a href="#"><i class="fa fa-skype" aria-hidden="true"></i></a></li>
                                    <li><a href="#"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="footer_nav_container">
                                <div class="cr">©2023 All Rights Reserverd. This template is made with <i
                                        class="fa fa-heart-o" aria-hidden="true"></i> by <a href="#">Colorlib</a> &amp;
                                    distributed by <a href="https://themewagon.com">ThemeWagon</a></div>
                            </div>
                        </div>
                    </div>
                </div>
            </footer>

    </div>



    <script src="/template/js/jquery-3.2.1.min.js"></script>
    <script src="/template/styles/bootstrap4/popper.js"></script>
    <script src="/template/styles/bootstrap4/bootstrap.min.js"></script>
    <script src="/template/plugins/Isotope/isotope.pkgd.min.js"></script>
    <script src="/template/plugins/OwlCarousel2-2.2.1/owl.carousel.js"></script>
    <script src="/template/plugins/easing/easing.js"></script>
    <script src="/template/plugins/jquery-ui-1.12.1.custom/jquery-ui.js"></script>
    <script src="/template/js/single_custom.js"></script>
    <script src="/main/js/jquery.min.js"></script>
    <script src="/main/js/bootstrap.min.js"></script>
    <script src="/main/js/slick.min.js"></script>
    <script src="/main/js/nouislider.min.js"></script>
    <script src="/main/js/jquery.zoom.min.js"></script>
    <script src="/main/js/main.js"></script>
    <script src="javascripts/address validation.js"></script>
    <script>
        const walletCheckbox = document.getElementById('wallet-0');
        const totalPriceLabel = document.querySelector('.order-submit');

        walletCheckbox.addEventListener('change', function () {
            if (this.checked) {
                const walletBalance = parseFloat('<%= userData.wallet %>');
                const totalPrice = parseFloat('<%= totalPrice %>');

                if (walletBalance >= totalPrice) {
                    totalPriceLabel.innerText = 'Pay 0';
                } else {
                    const remainingAmount = totalPrice - walletBalance;
                    totalPriceLabel.innerText = 'Pay ' + remainingAmount.toFixed(2);
                }
            } else {
                totalPriceLabel.innerText = 'Pay <%= totalPrice %>';
            }
        });
        function cancelSelection() {
            document.querySelector("select[name='coupon']").value = "";
            try {
                fetch('/cancelSelection', {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ selectedCouponId: selectedCouponId }),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        let totalPrice = parseFloat('<%= totalPrice %>');
                        totalPriceLabel.innerText = 'Pay ' + totalPrice.toFixed(2);
                    })
                    .catch((error) => {
                        console.error(error);
                    });
            } catch (error) {
                console.error(error);
            }
        }
        function applyCoupon(couponId) {
            try {
                selectedCouponId = couponId;
                document.querySelector("#couponCancelbutton").style.display = "block";
                fetch('/applyCoupon', {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ couponId: couponId }),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        let totalPrice = parseFloat('<%= totalPrice %>');
                        totalPrice = totalPrice - totalPrice * data * .01
                        totalPriceLabel.innerText = 'Pay ' + totalPrice.toFixed(2);
                    })
                    .catch((error) => {
                        console.error(error);
                    });
            } catch (error) {
                console.error(error);
            }
        }
        function submitOrder(event, userId, totalPrice) {

            const walletCheckbox = document.getElementById('wallet-0');
            const walletAmount = parseFloat('<%= userData.wallet %>');
            var walletFlag = 0
            if (walletCheckbox.checked) {
                if (walletAmount >= totalPrice) {
                    walletFlag = totalPrice
                    totalPrice = 0

                } else {
                    totalPrice = totalPrice - walletAmount
                    walletFlag = walletAmount
                }

            }

            let selectedPayment = '';
            const paymentRadios = document.getElementsByName('payment');
            for (let i = 0; i < paymentRadios.length; i++) {
                if (paymentRadios[i].checked) {
                    selectedPayment = paymentRadios[i].id;
                    break;
                }
            }
            if (selectedPayment) {
                const selectedAddressRadio = document.querySelector('input[name="selectedAddress"]:checked');
                if (selectedAddressRadio) {
                    const addressId = selectedAddressRadio.value;
                    const paymentMethod = selectedPayment.replace('payment-', '');

                    fetch("/createRP", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            userId: userId,
                            wallet: walletCheckbox.checked,
                            paymentMethod: paymentMethod
                        })
                    })
                        .then(response => response.json())

                        .then(data => {
                            rpOrderID = data.rpOrderId
                            if (rpOrderID == null) {
                                alert("Some Items are out of stock!")

                            } else if (selectedPayment == "payment-1" || selectedPayment == "payment-2") {
                                const url = `http://localhost:3000/placeOrder?addressId=${addressId}&payment=${paymentMethod}&wallet=${walletFlag}`
                                let options = {
                                    "key": "rzp_test_Z6ogCp3lsMS6mX",
                                    "amount": totalPrice * 100,
                                    "currency": "INR",
                                    "name": "ShoeME",
                                    "description": "Test Transaction",
                                    "image": "https://example.com/your_logo",
                                    "order_id": data.rpOrderID,
                                    "callback_url": url
                                }
                                let rzp1 = new Razorpay(options);
                                rzp1.open();
                            } else if (selectedPayment == "payment-0") {
                                const addressId = selectedAddressRadio.value;
                                const paymentMethod = selectedPayment.replace('payment-', '');
                                const url = `/placeOrder?addressId=${addressId}&payment=${paymentMethod}&wallet=${walletFlag}`;
                                window.location.href = url;

                            }
                        })
                        .catch(error => {
                            console.log(error);
                        });
                } else {
                    alert('No address selected');
                }
            } else {
                alert('No Payment Method Selected');
            }

        }

        const placeOrderLink = document.querySelector('.order-submit');
        const paymentRadios = document.querySelectorAll('input[name="payment"]');
        const addressRadios = document.querySelectorAll('input[name="selectedAddress"]');

        placeOrderLink.disabled = true;

        paymentRadios.forEach(radio => {
            radio.addEventListener('change', checkFormValidity);
        });

        addressRadios.forEach(radio => {
            radio.addEventListener('change', checkFormValidity);
        });

        function checkFormValidity() {
            const isPaymentSelected = Array.from(paymentRadios).some(radio => radio.checked);
            const isAddressSelected = Array.from(addressRadios).some(radio => radio.checked);
            placeOrderLink.disabled = !(isPaymentSelected && isAddressSelected);
        }

    </script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

</body>

</html>